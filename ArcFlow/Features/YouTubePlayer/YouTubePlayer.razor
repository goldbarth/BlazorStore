@page "/youtube"
@inject IJSRuntime JS
@inject YouTubePlayerStore Store
@inject ISnackbar Snackbar
@using ArcFlow.Features.YouTubePlayer.State
@using ArcFlow.Features.YouTubePlayer.Store
@implements IAsyncDisposable

<CreatePlaylistDrawer @bind-Open="_createPlaylistDrawerOpen"
                      OnSubmit="OnCreatePlaylistSubmit" />

<AddVideoDrawer @bind-Open="_addVideoDrawerOpen"
                SelectedPlaylistId="SelectedPlaylistId"
                OnSubmit="OnAddVideoSubmit" />

<h3>YouTube Player</h3>

<div class="youtube-player-container">
    <div class="playlist-overview">
        <h4>Playlists</h4>
        @if (!Playlists.Any())
        {
            <p>No playlists available</p>
            <MudButton StartIcon="@Icons.Material.Filled.Add"
                       Size="Size.Small"
                       Color="Color.Primary"
                       OnClick="OpenDrawer">
                New Playlist
            </MudButton>
        }
        else
        {
            <MudList T="Playlist" Class="playlist-list" Style="padding: 0;">
                @foreach (var playlist in Playlists)
                {
                    var currentPlaylist = playlist;
                    var isSelected = currentPlaylist.Id == SelectedPlaylistId;
                    <MudListItem Style="@GetPlaylistItemStyle(isSelected)"
                                 OnClick="@(async () =>
                        await Store.Dispatch(new YtAction.SelectPlaylist(currentPlaylist.Id)))">
                        <div class="playlist-item">
                            <strong>@currentPlaylist.Name</strong>
                            <span class="video-count">(@currentPlaylist.VideoItems.Count Videos)</span>
                        </div>
                    </MudListItem>
                }
            </MudList>
            <MudButton StartIcon="@Icons.Material.Filled.Add"
                       Size="Size.Small"
                       Color="Color.Primary"
                       OnClick="OpenDrawer">
                New Playlist
            </MudButton>
        }
    </div>

    <div class="video-player-section">
        <div class="video-player">
            <div id="youtube-player-container"></div>

            @if (State.Player is PlayerState.Empty)
            {
                <div class="no-video">
                    <p>Select a playlist and a video</p>
                </div>
            }
        </div>
        @if (CurrentVideo is not null)
        {
            <div class="player-controls">
                <MudIconButton Icon="@Icons.Material.Filled.Shuffle"
                               Size="Size.Medium"
                               Color="@(IsShuffleEnabled ? Color.Primary : Color.Default)"
                               OnClick="ToggleShuffle"/>
                <MudIconButton Icon="@Icons.Material.Filled.SkipPrevious"
                               Size="Size.Large"
                               Color="Color.Primary"
                               OnClick="PlayPrevious"
                               Disabled="!CanPlayPrevious"/>
                <MudIconButton Icon="@(IsPlaying
                                         ? Icons.Material.Filled.Pause
                                         : Icons.Material.Filled.PlayArrow)"
                               Size="Size.Large"
                               Color="Color.Primary"
                               OnClick="TogglePlayPause"/>
                <MudIconButton Icon="@Icons.Material.Filled.SkipNext"
                               Size="Size.Large"
                               Color="Color.Primary"
                               OnClick="PlayNext"
                               Disabled="!CanPlayNext"/>
                <MudIconButton Icon="@RepeatIcon"
                               Size="Size.Medium"
                               Color="@(CurrentRepeatMode != RepeatMode.Off ? Color.Primary : Color.Default)"
                               OnClick="CycleRepeat"/>
            </div>
        }
    </div>

    <div class="current-playlist">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h4>@(SelectedPlaylistName)</h4>
            <div>
                <MudIconButton Icon="@Icons.Material.Filled.Undo" OnClick="Undo" Disabled="!CanUndo" Size="Size.Small" />
                <MudIconButton Icon="@Icons.Material.Filled.Redo" OnClick="Redo" Disabled="!CanRedo" Size="Size.Small" />
            </div>
        </div>
        @if (Videos.Any())
        {
            <div id="video-sortable-list" class="video-list">
                @foreach (var video in Videos)
                {
                    var isSelected = video.YouTubeId == CurrentVideo?.YouTubeId;
                    <div @key="video.Id"
                         class="video-list-item @(video.YouTubeId == CurrentVideo?.YouTubeId
                                                    ? "selected"
                                                    : "")"
                         data-video-id="@video.Id"
                    >
                        <div class="drag-handle">
                            <MudIcon Icon="@Icons.Material.Filled.DragIndicator" Size="Size.Small"/>
                        </div>
                        <div class="video-item">
                            @if (!string.IsNullOrEmpty(video.ThumbnailUrl))
                            {
                                <img src="@video.ThumbnailUrl" alt="@video.Title"
                                     class="thumbnail"/>
                            }
                            <div class="video-info">
                                <div class="video-title-row">
                                    @if (isSelected && IsPlaying)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.PlayArrow"
                                                 Size="Size.Small"
                                                 Class="now-playing-icon"/>
                                    }
                                    <strong>@video.Title</strong>
                                </div>
                                @if (video.Duration.HasValue)
                                {
                                    <span class="duration">@video.Duration.Value.ToString(@"mm\:ss")</span>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
            <MudButton StartIcon="@Icons.Material.Filled.Add"
                       Size="Size.Small"
                       Color="Color.Primary"
                       OnClick="OpenAddVideoDrawer">
                Add Video
            </MudButton>
        }
        else if (SelectedPlaylistId != null)
        {
            <p>No videos in this playlist</p>
            <MudButton StartIcon="@Icons.Material.Filled.Add"
                       Size="Size.Small"
                       Color="Color.Primary"
                       OnClick="OpenAddVideoDrawer">
                Add Video
            </MudButton>
        }
    </div>
</div>
