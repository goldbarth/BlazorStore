@page "/youtube"

<CreatePlaylistDrawer @bind-Open="_createPlaylistDrawerOpen"
                      OnSubmit="OnCreatePlaylistSubmit" />

<AddVideoDrawer @bind-Open="_addVideoDrawerOpen"
                SelectedPlaylistId="SelectedPlaylistId"
                OnSubmit="OnAddVideoSubmit" />

<PageTitle>YouTube Player</PageTitle>

<MudText Typo="Typo.h4" Align="Align.Left" Class="mt-4 mb-2"
         Style="color: white;">YouTube Player</MudText>

<ImportExportToolbar State="State"
                     OnExportClick="OnExportClick"
                     OnImportClick="OpenImportDrawer"
                     OnPersistRetryClick="OnPersistRetry" />

<ImportDrawer @bind-Open="_importDrawerOpen"
              ImportExportState="State.ImportExport"
              OnSubmit="OnImportSubmit" />

<div class="youtube-player-container">
    <div class="playlist-overview">
        <MudText Typo="Typo.h5" Align="Align.Left" Class="mb-2"
                                   Style="color: black; font-style: italic">Playlists</MudText>
        @if (!Playlists.Any())
        {
            <MudText Typo="Typo.body2" Align="Align.Left"
                     Style="color: black;">No playlists available</MudText>
            <MudButton StartIcon="@Icons.Material.Filled.Add"
                       Size="Size.Small"
                       Color="Color.Dark"
                       OnClick="OpenDrawer">
                New Playlist
            </MudButton>
        }
        else
        {
            <MudList T="Playlist" Class="playlist-list" Style="padding: 0;">
                @foreach (var playlist in Playlists)
                {
                    var currentPlaylist = playlist;
                    var isSelected = currentPlaylist.Id == SelectedPlaylistId;
                    <MudListItem Style="@GetPlaylistItemStyle(isSelected)"
                                 OnClick="@(async () =>
                        await Store.Dispatch(new YtAction.SelectPlaylist(currentPlaylist.Id)))">
                        <div class="playlist-item">
                            <MudText Typo="Typo.body1" Align="Align.Left"
                                     Style="color: black;">@currentPlaylist.Name</MudText>
                            <MudText Typo="Typo.caption" Align="Align.Left"
                                     Style="color: gray;">(@currentPlaylist.VideoItems.Count Videos)</MudText>
                        </div>
                    </MudListItem>
                }
            </MudList>
            <MudButton StartIcon="@Icons.Material.Filled.Add"
                       Size="Size.Small"
                       Color="Color.Dark"
                       OnClick="OpenDrawer">
                New Playlist
            </MudButton>
        }
    </div>

    <div class="video-player-section">
        <div class="video-player">
            <div id="youtube-player-container"></div>

            @if (State.Player is PlayerState.Empty)
            {
                <div class="no-video">
                    <MudText Typo="Typo.body2" Align="Align.Left"
                             Style="color: black;">Select a playlist</MudText>
                </div>
            }
        </div>
        @if (CurrentVideo is not null)
        {
            <div class="player-controls">
                <MudIconButton Icon="@Icons.Material.Filled.Shuffle"
                               Size="Size.Medium"
                               Color="@(IsShuffleEnabled ? Color.Dark : Color.Default)"
                               OnClick="ToggleShuffle"/>
                <MudIconButton Icon="@Icons.Material.Filled.SkipPrevious"
                               Size="Size.Large"
                               Color="Color.Dark"
                               OnClick="PlayPrevious"
                               Disabled="!CanPlayPrevious"/>
                <MudIconButton Icon="@(IsPlaying
                                         ? Icons.Material.Filled.Pause
                                         : Icons.Material.Filled.PlayArrow)"
                               Size="Size.Large"
                               Color="Color.Dark"
                               OnClick="TogglePlayPause"/>
                <MudIconButton Icon="@Icons.Material.Filled.SkipNext"
                               Size="Size.Large"
                               Color="Color.Dark"
                               OnClick="PlayNext"
                               Disabled="!CanPlayNext"/>
                <MudIconButton Icon="@RepeatIcon"
                               Size="Size.Medium"
                               Color="@(CurrentRepeatMode != RepeatMode.Off ? Color.Dark : Color.Default)"
                               OnClick="CycleRepeat"/>
            </div>
        }
    </div>

    <div class="current-playlist">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <MudText Typo="Typo.h5" Align="Align.Left" Class="mb-2"
                     Style="color: black; font-style: italic">@(SelectedPlaylistName)</MudText>
            <div>
                <MudIconButton Icon="@Icons.Material.Filled.Undo" OnClick="Undo" Disabled="!CanUndo" Size="Size.Small"/>
                <MudIconButton Icon="@Icons.Material.Filled.Redo" OnClick="Redo" Disabled="!CanRedo" Size="Size.Small"/>
            </div>
        </div>
        @if (Videos.Any())
        {
            <div id="video-sortable-list" class="video-list">
                @foreach (var video in Videos)
                {
                    var isSelected = video.YouTubeId == CurrentVideo?.YouTubeId;
                    <div @key="video.Id"
                         class="video-list-item @(video.YouTubeId == CurrentVideo?.YouTubeId
                                                    ? "selected"
                                                    : "")"
                         data-video-id="@video.Id"
                    >
                        <div class="drag-handle">
                            <MudIcon Icon="@Icons.Material.Filled.DragIndicator" Size="Size.Small"/>
                        </div>
                        <div class="video-item">
                            @if (!string.IsNullOrEmpty(video.ThumbnailUrl))
                            {
                                <img src="@video.ThumbnailUrl" alt="@video.Title"
                                     class="thumbnail"/>
                            }
                            <div class="video-info">
                                <div class="video-title-row">
                                    @if (isSelected && IsPlaying)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.PlayArrow"
                                                 Size="Size.Small"
                                                 Class="now-playing-icon"/>
                                    }
                                    <MudText Typo="Typo.body1" Align="Align.Left"
                                             Style="color: black;">@video.Title</MudText>
                                </div>
                                @if (video.Duration.HasValue)
                                {
                                    <span class="duration">@video.Duration.Value.ToString(@"mm\:ss")</span>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
            <MudButton StartIcon="@Icons.Material.Filled.Add"
                       Size="Size.Small"
                       Color="Color.Dark"
                       OnClick="OpenAddVideoDrawer">
                Add Video
            </MudButton>
        }
        else if (SelectedPlaylistId != null)
        {
            <MudText Typo="Typo.body2" Align="Align.Left"
                     Style="color: black;">No videos in this playlist</MudText>
            <MudButton StartIcon="@Icons.Material.Filled.Add"
                       Size="Size.Small"
                       Color="Color.Dark"
                       OnClick="OpenAddVideoDrawer">
                Add Video
            </MudButton>
        }
    </div>
</div>
